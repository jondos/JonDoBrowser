
all: jdb-de jdb-en

# fetch the latest Firefox ESR and JonDoFox Profile and modify profile for JDB
fetch:  buildtmp/.step-fetch-done
buildtmp/.step-fetch-done:
	chmod +x helpers/*.sh
	mkdir buildtmp
	helpers/fetch-ff-source.sh && helpers/fetch-de-xpi-linux.sh && touch buildtmp/.step-fetch-done


# Unpack the firefox source to buildtmp/mozilla-release
unpack: buildtmp/.step-unpack-done
buildtmp/.step-unpack-done: buildtmp/.step-fetch-done
	tar -xj --directory buildtmp -f buildtmp/firefox-*esr.source.tar.bz2
	mv buildtmp/mozilla-esr* buildtmp/mozilla-release
	touch buildtmp/.step-unpack-done


# apply JonDoBrowser patches
patch: buildtmp/.step-patch-done
buildtmp/.step-patch-done: buildtmp/.step-unpack-done
	helpers/patch-ff-source.sh && touch buildtmp/.step-patch-done


# Compile Firefox and create a TAR.BZ2 archive
compile: buildtmp/firefox.tar.bz2
buildtmp/firefox.tar.bz2: buildtmp/.step-patch-done
	cp -f .mozconfig_linux buildtmp/mozilla-release/.mozconfig
	helpers/compile-linux.sh


# Unpack the compiled Firefox and replace search engines, repack en-US Firefox
firefox-en: buildtmp/firefox_en-US.tar.bz2
buildtmp/firefox_en-US.tar.bz2: buildtmp/firefox.tar.bz2
	tar -xaf buildtmp/firefox.tar.bz2
	rm firefox/browser/searchplugins/*.xml
	cp searchplugins/common/*.xml firefox/browser/searchplugins/
	chmod -x firefox/browser/searchplugins/*.xml
	tar -cjf buildtmp/firefox_en-US.tar.bz2 firefox
	rm -r firefox


# Unpack the compiles Firefox and apply all modifications for German version
firefox-de: buildtmp/firefox_de.tar.bz2
buildtmp/firefox_de.tar.bz2: buildtmp/firefox.tar.bz2
	tar -xaf buildtmp/firefox.tar.bz2
	rm firefox/browser/searchplugins/*.xml
	cp searchplugins/common/*.xml firefox/browser/searchplugins/
	cp searchplugins/de/*.xml firefox/browser/searchplugins/
	chmod -x firefox/browser/searchplugins/*.xml
	tar -cjf buildtmp/firefox_de.tar.bz2 firefox
	rm -r firefox


# Pack JonDoBrowser en-US
jdb-en: JonDoBrowser-en-US.tar.xz
JonDoBrowser-en-US.tar.xz: buildtmp/firefox_en-US.tar.bz2
	mkdir JonDoBrowser
	cp linux/start-jondobrowser_en-US.sh JonDoBrowser/start-jondobrowser.sh
	chmod +x JonDoBrowser/start-jondobrowser.sh
	cp linux/install-jondobrowser.sh JonDoBrowser/install-jondobrowser.sh
	chmod +x JonDoBrowser/install-jondobrowser.sh
	cp linux/uninstall-jondobrowser.sh JonDoBrowser/uninstall-jondobrowser.sh
	chmod +x JonDoBrowser/uninstall-jondobrowser.sh
	mkdir JonDoBrowser/App
	tar -xj --directory JonDoBrowser/App -f buildtmp/firefox_en-US.tar.bz2
	mkdir JonDoBrowser/Data
	cp -r buildtmp/profile JonDoBrowser/Data/
	sed -i "s/Arial/Liberation Sans/" JonDoBrowser/Data/profile/prefs.js
	mv -f JonDoBrowser/Data/profile/places.sqlite_en-US JonDoBrowser/Data/profile/places.sqlite
	rm -f JonDoBrowser/Data/profile/places.sqlite_de
	cp linux/jondobrowser.png JonDoBrowser/misc/
	cp linux/jondobrowser.desktop JonDoBrowser/misc/
	cp debian/bin-en/jondobrowser JonDoBrowser/misc/
	chmod +x JonDoBrowser/misc/jondobrowser
	tar -cf JonDoBrowser-en-US.tar JonDoBrowser
	xz JonDoBrowser-en-US.tar
	rm -r JonDoBrowser


# Pack JonDoBrowser de
jdb-de: JonDoBrowser-de.tar.xz
JonDoBrowser-de.tar.xz: buildtmp/firefox_de.tar.bz2
	mkdir JonDoBrowser 
	cp linux/start-jondobrowser_de.sh JonDoBrowser/start-jondobrowser.sh
	chmod +x JonDoBrowser/start-jondobrowser.sh
	cp linux/install-jondobrowser.sh JonDoBrowser/install-jondobrowser.sh
	chmod +x JonDoBrowser/install-jondobrowser.sh
	cp linux/uninstall-jondobrowser.sh JonDoBrowser/uninstall-jondobrowser.sh
	chmod +x JonDoBrowser/uninstall-jondobrowser.sh
	mkdir JonDoBrowser/App
	tar -xj --directory JonDoBrowser/App -f buildtmp/firefox_de.tar.bz2
	mdir JonDoBrowser/Data
	cp -r buildtmp/profile JonDoBrowser/Data/
	sed -i "s/Arial/Liberation Sans/" JonDoBrowser/Data/profile/prefs.js
	cp buildtmp/de.xpi JonDoBrowser/Data/profile/extensions/langpack-de@firefox.mozilla.org.xpi
	chmod -x JonDoBrowser/Data/profile/extensions/langpack-de@firefox.mozilla.org.xpi
	echo "user_pref(\"extensions.langpack-de@firefox.mozilla.org.update.enabled\", false);" >> JonDoBrowser/Data/profile/prefs.js
	mv -f JonDoBrowser/Data/profile/places.sqlite_de JonDoBrowser/Data/profile/places.sqlite
	rm -f JonDoBrowser/Data/profile/places.sqlite_en_US
	mkdir JonDoBrowser/misc
	cp linux/jondobrowser.png JonDoBrowser/misc/
	cp linux/jondobrowser.desktop JonDoBrowser/misc/
	cp debian/bin-de/jondobrowser JonDoBrowser/misc/
	chmod +x JonDoBrowser/misc/jondobrowser
	tar -cf JonDoBrowser-de.tar JonDoBrowsers
	xz JonDoBrowser-de.tar
	rm -r JonDoBrowser


# Build the full mar file
mar: buildtmp/.step-mar-done
buildtmp/.step-mar-done: buildtmp/.step-postcompile-done
	echo "mar is not implemented"
	touch buildtmp/.step-mar-done

clean:
	rm -rf buildtmp

